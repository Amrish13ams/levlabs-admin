<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Studio Admin | Product & Fabric Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="config.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .admin-card { @apply bg-white border border-gray-200 rounded-xl p-5 mb-6 shadow-sm; }
        .btn-primary { @apply w-full bg-black text-white text-[10px] font-bold uppercase tracking-widest py-3 rounded-lg hover:bg-gray-800 transition-all; }
        .input-field { @apply w-full border border-gray-200 rounded-lg p-2 text-sm mt-1 focus:border-black outline-none; }
        .label-text { @apply block text-[10px] font-black uppercase text-gray-400 tracking-wider; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900" x-data="studioEngine()">

    <div class="flex h-screen overflow-hidden">
        
        <aside class="w-2/5 border-r border-gray-200 overflow-y-auto p-10 bg-white">
            <h2 class="text-3xl font-black italic uppercase mb-10 tracking-tighter">Studio Config</h2>

            <div class="admin-card">
                <h3 class="font-bold text-xs uppercase mb-4 border-b pb-2">Fabric Groups</h3>
                <div class="space-y-4">
                    <div>
                        <label class="label-text">Group Name</label>
                        <input type="text" x-model="groupForm.name" class="input-field" placeholder="e.g. Summer Linens">
                    </div>
                    <button @click="createGroup()" class="btn-primary">Create Group</button>
                </div>
            </div>

            <div class="admin-card">
                <h3 class="font-bold text-xs uppercase mb-4 border-b pb-2">Fabric Management</h3>
                <div class="space-y-4">
                    <div>
                        <label class="label-text">Select Group</label>
                        <select x-model="fabricForm.group_id" class="input-field">
                            <option value="">Choose a Group...</option>
                            <template x-for="g in fabricGroups" :key="g.id">
                                <option :value="g.id" x-text="g.name"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="label-text">Fabric Name</label>
                        <input type="text" x-model="fabricForm.name" class="input-field" placeholder="e.g. Royal Blue Twill">
                    </div>
                    <div>
                        <label class="label-text">Upload Image</label>
                        <input type="file" x-ref="fabricFile" @change="fabricForm.image = $event.target.files[0]" class="input-field">
                    </div>
                    <button @click="createFabric()" class="btn-primary">Add New Fabric</button>
                </div>
            </div>

            <div class="admin-card">
                <h3 class="font-bold text-xs uppercase mb-4 border-b pb-2">Product & Attribute Builder</h3>
                <div class="space-y-4">
                    <div>
                        <label class="label-text">Parent Product</label>
                        <select x-model="productForm.parent_id" class="input-field">
                            <option value="">(Root Product)</option>
                            <template x-for="p in flatProducts" :key="p.id">
                                <option :value="p.id" x-text="p.name"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="label-text">Item Name</label>
                        <input type="text" x-model="productForm.name" class="input-field" placeholder="e.g. Notch Lapel or 8cm Width">
                    </div>
                    
                    <div x-show="!productForm.parent_id">
                        <label class="label-text">Assign Fabric Group (Roots)</label>
                        <select x-model="productForm.fabric_group_id" class="input-field">
                            <option value="">None</option>
                            <template x-for="g in fabricGroups" :key="g.id">
                                <option :value="g.id" x-text="g.name"></option>
                            </template>
                        </select>
                    </div>

                    <div>
                        <label class="label-text">Define Attributes (comma separated)</label>
                        <input type="text" x-model="productForm.attributes" class="input-field" placeholder="width, buttonhole, stitching">
                    </div>

                    <div x-show="productForm.parent_id">
                        <label class="label-text">Attribute Name (for options)</label>
                        <input type="text" x-model="productForm.attribute_name" class="input-field" placeholder="e.g. width (if this is an option)">
                    </div>

                    <div>
                        <label class="label-text">Price (Optional)</label>
                        <input type="number" x-model="productForm.price" class="input-field" placeholder="0.00">
                    </div>

                    <button @click="createProductNode()" class="btn-primary">Save to Tree</button>
                </div>
            </div>

            <div class="admin-card">
                <h3 class="font-bold text-xs uppercase mb-4 border-b pb-2">Bulk JSON Operations</h3>
                <div class="space-y-2">
                    <textarea x-model="jsonBlueprint" class="input-field h-32 font-mono text-[10px]" placeholder="Paste JSON tree here..."></textarea>
                    <div class="flex gap-2">
                        <button @click="loadCurrentTree()" class="btn-primary bg-gray-500 hover:bg-gray-600">Export JSON</button>
                        <button @click="saveBlueprint()" class="btn-primary">Import / Update</button>
                    </div>
                    <a href="tree-editor.html" class="block text-center text-[10px] text-blue-500 underline mt-3 hover:text-blue-700">Open Full Screen Editor</a>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-gray-100 flex items-center justify-center p-10">
            <div class="w-[380px] h-[780px] bg-white rounded-[3.5rem] shadow-2xl border-[10px] border-white relative flex flex-col overflow-hidden">
                
                <header class="p-8 pb-4">
                    <div class="flex items-center justify-between mb-6">
                        <button @click="goBack()" x-show="history.length > 0" class="w-10 h-10 border border-gray-100 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg>
                        </button>
                        <h4 class="text-[10px] font-black uppercase tracking-[0.2em]" x-text="viewTitle"></h4>
                        <div class="w-10"></div>
                    </div>

                    <!-- Fabric Selector -->
                    <div class="px-8 mb-4" x-show="availableFabrics.length > 0">
                        <label class="label-text mb-1">Preview Fabric</label>
                        <select x-model="selectedFabricId" class="input-field text-xs py-1">
                            <template x-for="f in availableFabrics" :key="f.id">
                                <option :value="f.id" x-text="f.name"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Style Selector (Visible when inside a Category like Lapel) -->
                    <template x-if="activeCategory && activeCategory.sub_products.length > 0">
                        <div class="px-8 mb-2">
                            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                                <template x-for="style in activeCategory.sub_products" :key="style.id">
                                    <button @click="selectedStyle = style"
                                        class="px-4 py-2 rounded-xl border text-[10px] font-bold uppercase tracking-wider transition-all shrink-0"
                                        :class="selectedStyle?.id === style.id ? 'bg-black text-white border-black' : 'bg-white text-gray-500 border-gray-200 hover:border-gray-300'">
                                        <span x-text="style.name"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template x-if="activeCategory?.attributes">
                        <div class="flex gap-6 overflow-x-auto no-scrollbar border-b border-gray-100">
                            <template x-for="attr in activeCategory.attributes" :key="attr">
                                <button @click="activeAttr = attr" 
                                    class="text-[10px] font-bold uppercase pb-3 transition-all"
                                    :class="activeAttr === attr ? 'border-b-2 border-black text-black' : 'text-gray-400'"
                                    x-text="attr"></button>
                            </template>
                        </div>
                    </template>
                </header>

                <div class="flex-1 overflow-y-auto px-8 no-scrollbar">
                    
                    <template x-if="!activeAttr">
                        <div class="space-y-4">
                            <template x-for="item in currentNodes" :key="item.id">
                                <div @click="drillDown(item)" class="group border border-gray-100 rounded-2xl p-4 flex items-center gap-4 cursor-pointer hover:border-black transition-all">
                                    <button @click.stop="deleteProduct(item.id)" class="text-red-400 hover:text-red-600 font-bold text-[10px] uppercase px-2">Del</button>
                                    <div class="w-14 h-14 bg-gray-50 rounded-xl overflow-hidden shrink-0">
                                        <img :src="getImg(item)" class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-[11px] font-bold uppercase tracking-tight" x-text="item.name"></p>
                                        <p class="text-[9px] text-gray-400 uppercase" x-text="item.sub_products.length + ' options'"></p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <template x-if="activeAttr">
                        <div class="space-y-6 pt-4">
                            <!-- Selected Style Preview -->
                            <div x-show="selectedStyle" class="border border-gray-200 rounded-3xl p-5 flex gap-5 bg-gray-50">
                                <div class="w-20 h-20 bg-gray-100 rounded-2xl overflow-hidden shrink-0">
                                    <img :src="getImg(selectedStyle)" class="w-full h-full object-cover">
                                </div>
                                <div class="flex flex-col justify-center">
                                    <h5 class="text-sm font-black italic uppercase" x-text="selectedStyle?.name"></h5>
                                    <p class="text-[10px] text-gray-400 leading-tight mt-1" x-text="selectedStyle?.description || 'Select options below.'"></p>
                                </div>
                            </div>
                            
                            <div x-show="!selectedStyle" class="p-5 text-center border border-dashed border-gray-200 rounded-2xl">
                                <p class="text-[10px] text-gray-400 uppercase">No styles defined for this category yet.</p>
                            </div>

                            <div class="grid grid-cols-1 gap-2">
                                <template x-for="opt in getAttrOptions()" :key="opt.id">
                                    <button class="flex items-center justify-between p-5 border border-gray-100 rounded-2xl text-[10px] font-bold uppercase tracking-widest hover:bg-black hover:text-white hover:border-black transition-all">
                                        <span x-text="opt.name"></span>
                                        <span class="opacity-50" x-text="opt.price > 0 ? '+$' + opt.price : 'Incl.'"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <footer class="p-8 border-t border-gray-50">
                    <button class="w-full bg-black text-white py-5 rounded-2xl text-[10px] font-bold uppercase tracking-[0.3em]">Add to Bag</button>
                </footer>
            </div>
        </main>
    </div>

    <script>
        function studioEngine() {
            return {
                // CRUD Forms
                groupForm: { name: '' },
                fabricForm: { name: '', group_id: '', image: null },
                productForm: { name: '', parent_id: '', attributes: '', fabric_group_id: '', attribute_name: '', price: '' },
                
                jsonBlueprint: '',
                // Data
                fabricGroups: [],
                flatProducts: [], // Used for parent selection dropdown
                tree: [],
                availableFabrics: [],
                selectedFabricId: null,
                
                // UI State
                currentNodes: [],
                history: [],
                viewTitle: 'The Customizer',
                activeCategory: null,
                activeAttr: null,
                selectedStyle: null,

                async init() {
                    await this.refreshAll();
                },

                async refreshAll() {
                    const treeRes = await fetch(`${API_BASE_URL}/products/tree`);
                    this.tree = await treeRes.json();
                    this.currentNodes = this.tree;
                    
                    // Fetch groups for dropdown
                    const groupRes = await fetch(`${API_BASE_URL}/fabric-groups`);
                    this.fabricGroups = await groupRes.json();
                    
                    // Flatten tree for parent selector
                    this.flatProducts = this.flattenTree(this.tree);

                    // Extract fabrics from root(s) for preview
                    this.availableFabrics = this.tree.flatMap(r => r.fabrics || []);
                    if (this.availableFabrics.length > 0 && !this.selectedFabricId) {
                        this.selectedFabricId = this.availableFabrics[0].id;
                    }
                },

                flattenTree(nodes, depth = 0, list = []) {
                    nodes.forEach(node => {
                        list.push({ id: node.id, name: '-'.repeat(depth) + ' ' + node.name });
                        if (node.sub_products && node.sub_products.length > 0) {
                            this.flattenTree(node.sub_products, depth + 1, list);
                        }
                    });
                    return list;
                },

                async createGroup() {
                    await fetch(`${API_BASE_URL}/fabric-groups`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.groupForm)
                    });
                    this.groupForm.name = '';
                    await this.refreshAll();
                },

                async createFabric() {
                    const formData = new FormData();
                    formData.append('name', this.fabricForm.name);
                    formData.append('fabric_group_id', this.fabricForm.group_id);
                    if (this.fabricForm.image) {
                        formData.append('image', this.fabricForm.image);
                    }

                    await fetch(`${API_BASE_URL}/fabrics`, {
                        method: 'POST',
                        body: formData
                    });
                    this.fabricForm.name = '';
                    this.fabricForm.image = null;
                    this.$refs.fabricFile.value = '';
                    await this.refreshAll();
                    alert('Fabric Added');
                },

                async createProductNode() {
                    const attrs = this.productForm.attributes.split(',').map(s => s.trim()).filter(s => s !== '');
                    
                    const formData = new FormData();
                    formData.append('name', this.productForm.name);
                    if (this.productForm.parent_id) formData.append('parent_id', this.productForm.parent_id);
                    formData.append('attributes_list', JSON.stringify(attrs));
                    if (this.productForm.fabric_group_id) formData.append('fabric_group_id', this.productForm.fabric_group_id);
                    if (this.productForm.attribute_name) formData.append('attribute_name', this.productForm.attribute_name);
                    formData.append('price', this.productForm.price || 0);

                    await fetch(`${API_BASE_URL}/products`, {
                        method: 'POST',
                        body: formData
                    });
                    this.productForm.name = '';
                    this.productForm.attributes = '';
                    this.productForm.price = '';
                    await this.refreshAll();
                    alert('Tree Updated');
                },

                loadCurrentTree() {
                    // Clean tree to remove read-only fields and presigned URLs before export
                    const clean = (nodes) => nodes.map(n => {
                        const { fabrics, ...rest } = n; // Keep fabric_images, remove fabrics list (read-only from group)
                        if (rest.sub_products) rest.sub_products = clean(rest.sub_products);
                        if (rest.attributes && Array.isArray(rest.attributes)) {
                            rest.attributes.forEach(attr => {
                                if (Array.isArray(rest[attr])) rest[attr] = clean(rest[attr]);
                            });
                        }
                        return rest;
                    });
                    this.jsonBlueprint = JSON.stringify(clean(this.tree), null, 2);
                },

                async saveBlueprint() {
                    try {
                        const data = JSON.parse(this.jsonBlueprint);
                        await fetch(`${API_BASE_URL}/products/tree`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(data)
                        });
                        await this.refreshAll();
                        alert('Bulk Update Successful');
                    } catch(e) {
                        alert('Error: ' + e.message);
                    }
                },

                async deleteProduct(id) {
                    if(!confirm('Delete this product and all children?')) return;
                    await fetch(`${API_BASE_URL}/products/${id}`, {
                        method: 'DELETE'
                    });
                    await this.refreshAll();
                },

                // Preview Logic
                drillDown(node) {
                    this.history.push({ nodes: [...this.currentNodes], title: this.viewTitle, cat: this.activeCategory });
                    
                    // If node has attributes (e.g. Lapel), enter Category Mode
                    if (node.attributes && node.attributes.length > 0) {
                        this.activeCategory = node;
                        this.selectedStyle = (node.sub_products && node.sub_products.length > 0) ? node.sub_products[0] : null;
                        this.activeAttr = node.attributes[0];
                    } else {
                        this.currentNodes = node.sub_products;
                    }
                    this.viewTitle = node.name;
                },

                getAttrOptions() {
                    if (!this.selectedStyle || !this.activeAttr) return [];
                    // New Logic: Access the array directly via the attribute name key (e.g. selectedStyle['width'])
                    return this.selectedStyle[this.activeAttr] || [];
                },

                goBack() {
                    const prev = this.history.pop();
                    this.currentNodes = prev.nodes;
                    this.viewTitle = prev.title;
                    this.activeCategory = prev.cat;
                    this.activeAttr = null;
                },

                getImg(node) {
                    if (!node || !node.fabric_images) return '';
                    if (this.selectedFabricId && node.fabric_images[this.selectedFabricId]) {
                        return node.fabric_images[this.selectedFabricId];
                    }
                    const values = Object.values(node.fabric_images);
                    return values.length > 0 ? values[0] : '';
                }
            }
        }
    </script>
</body>
</html>